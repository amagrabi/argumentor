<!DOCTYPE html>
<html lang="{{ session.get('language', 'en') }}">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-51N4QB84CL"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-51N4QB84CL");
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="google-signin-client_id"
      content="{{ GOOGLE_CLIENT_ID }}"
      data-use-fedcm="true"
    />
    <meta name="user-authenticated" content="{{ current_user.is_authenticated | string | lower }}" />
    <meta name="user-username" content="{{ current_user.username if current_user.is_authenticated else 'Anonymous' }}" />
    <title>ArguMentor - Train Logical Reasoning</title>
    <meta
      name="description"
      content="ArguMentor is a platform that helps you build & refine your reasoning skills. Construct compelling arguments and receive AI-driven feedback to improve your decision-making."
    />
    <link rel="canonical" href="https://www.argumentorai.com" />
    <meta
      property="og:description"
      content="Test and improve your reasoning skills. Construct arguments to challenging questions and receive in-depth, AI-driven feedback."
    />
    <meta property="og:url" content="https://www.argumentorai.com" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="ArguMentor - Sharpen Your Reasoning Skills"
    />
    <meta
      name="twitter:description"
      content="Join a community focused on building better arguments and decision-making skills through AI-driven feedback."
    />
    <script>
      // Load translations immediately
      (async function loadTranslations() {
        const currentLanguage = localStorage.getItem("language") || "en";
        try {
          const response = await fetch(
            `/static/translations/${currentLanguage}.json`
          );
          if (!response.ok) throw new Error("Failed to load translations");
          window.translations = await response.json();
        } catch (error) {
          console.error("Error loading translations:", error);
        }
      })();
    </script>
    <!-- Critical Scripts - Load immediately -->
    <script type="module" src="/static/js/translationManager.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            screens: {
              'xs': '290px',
            },
          },
        },
      }
    </script>

    <!-- Link to custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    {% include 'partials/favicons.html' %}

    <!-- Video styles -->
    <style>
      /* Override default video controls */
      video::-webkit-media-controls-overlay-play-button {
        display: none;
      }

      video::-webkit-media-controls {
        display: none;
      }

      video::-webkit-media-controls-panel {
        display: none;
      }

      video {
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .video-ended-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        opacity: 0.9;
        transition: opacity 0.2s;
      }

      .video-ended-button:hover {
        opacity: 1;
        background-color: rgba(0, 0, 0, 0.8);
      }

      .video-play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
      }

      .video-play-button:hover {
        opacity: 1;
        background-color: rgba(0, 0, 0, 0.7);
      }

      /* Hover effect for playing video */
      #videoContainer:hover .video-hover-effect {
        opacity: 1;
      }

      .video-hover-effect {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        background-color: rgba(0, 0, 0, 0.3);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: auto; /* Make it clickable */
      }

      .video-loading {
        position: relative;
        min-height: 200px;
        background-color: #f3f4f6;
      }

      .video-loading::after {
        content: "Loading...";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #6b7280;
        font-size: 16px;
      }

      .video-needs-interaction::after {
        content: "Tap to play";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 120px;
        height: 60px;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        border-radius: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        cursor: pointer;
        opacity: 0.9;
      }

      /* Loading animation for page transitions */
      .page-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .page-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <!-- Non-critical scripts - Load deferred -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>
    <script src="/static/js/vendors/date-fns.umd.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.1/dist/purify.min.js" defer></script>

    <!-- Add achievements data before module scripts -->
    <script id="all-achievements-data" type="application/json">
      {{ all_achievements | tojson | safe }}
    </script>

    <!-- Core JavaScript Modules -->
    <script type="module" src="/static/js/constants.js"></script>
    <script type="module" src="/static/js/helpers.js"></script>
    <script type="module" src="/static/js/voice.js" defer></script>
    <script type="module" src="/static/js/main.js" defer></script>

    <!-- Initialize translations -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        window.translationManager?.applyTranslations();
      });
    </script>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "ArguMentor",
        "url": "https://www.argumentorai.com",
        "description": "A platform to improve your reasoning and decision-making through AI-driven feedback and thoughtful challenges."
      }
    </script>
    <script type="module" src="/static/js/translations.js"></script>
    <script>
      // Hide loading indicator when page is loaded
      window.addEventListener('load', function() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'none';
        }

        // Check if we should show the login modal
        {% if show_login %}
        if (typeof showAuthModal === 'function' && !{{ current_user.is_authenticated | string | lower }}) {
          setTimeout(function() {
            showAuthModal();
          }, 500); // Small delay to ensure everything is loaded
        }
        {% endif %}
      });

      // Also handle browser back/forward navigation
      window.addEventListener('pageshow', function(event) {
        // The pageshow event is fired when the page is shown, including when navigating back
        // The persisted property indicates if the page is being loaded from the cache (back/forward navigation)
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'none';
        }
      });
    </script>
  </head>
  <body class="bg-white min-h-screen">
    <!-- Loading Indicator -->
    <div id="loadingOverlay" class="page-loading-overlay" style="display: none;">
      <div class="page-loading-spinner"></div>
    </div>

    <div class="max-w-5xl mx-auto px-4 py-6">
      <!-- Header -->
      <header class="flex flex-col xs:flex-row justify-between items-center mb-2 xs:mb-4">
        <!-- Left side with logo -->
        <div class="flex items-center justify-start w-auto mb-1 xs:mb-0">
          <img
            width="60"
            height="60"
            src="{{ url_for('static', filename='img/logo.png') }}"
            alt="ArguMentor"
            class="mt-1 sm:mt-1 sm:w-[60px] w-[28px] xs:w-[32px]"
          />
          <h1 class="text-xs xs:text-sm sm:text-2xl font-bold" style="margin-left: 4px; margin-top: 0px">
            ArguMentor
          </h1>
        </div>

        <!-- Center section with level indicator -->
        <div class="flex-1 flex justify-center items-center mt-1 xs:mt-2 sm:mt-1">
          <a href="/profile" class="no-underline">
            <div id="userInfo" class="flex items-center space-x-0">
              <!-- Level image wrapper -->
              <div class="level-image-wrapper relative z-10">
                {% set variant = "header" %}{% set show_text = false %}{%
                include 'partials/level_indicator.html' %}
                <div
                  class="level-number-indicator absolute -top-2 left-1/2 transform -translate-x-[60%] w-4 h-4 text-[8px] flex items-center justify-center"
                  style="border: 1px solid white; background-color: black"
                >
                  {{ level_info.level_number }}
                </div>
              </div>
              <!-- User details with adjusted spacing -->
              <div class="flex flex-col">
                <span id="usernameElem" class="text-[10px] text-gray-700">
                  {{ current_user.username if current_user.is_authenticated else
                  'Anonymous' }}
                </span>
                <span id="userLevelElem" class="text-[10px] text-gray-600">
                  {{ level_info.display_name }}
                </span>
                <div
                  class="xp-bar-container mini-xp-bar mt-1 w-[280px] flex-none"
                  style="margin-left: -30px; position: relative; z-index: 0"
                >
                  <div
                    id="miniXpBarFill"
                    class="xp-progress-bar bg-gray-600 h-2"
                    style="width: {{ level_info.progress_percent }}%;"
                  ></div>
                </div>
              </div>
            </div>
          </a>
        </div>

        <!-- Right side with buttons -->
        <div class="flex items-center justify-end space-x-0.5 sm:space-x-2 mt-1 xs:mt-0">
          {% if current_user.is_authenticated %}
          <button
            id="logoutButton"
            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 sm:px-4 py-1 sm:py-2 rounded-full text-xs sm:text-sm h-8 sm:h-8"
            data-i18n="header.logout"
          >
            Logout
          </button>
          {% else %}
          <button
            id="loginButton"
            onclick="showAuthModal()"
            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 sm:px-4 py-1 sm:py-2 rounded-full text-xs sm:text-sm h-8 sm:h-8"
            data-i18n="header.login"
          >
            Login
          </button>
          {% endif %}
          <a
            id="profileButton"
            href="/profile"
            class="profile-button bg-gray-100 hover:bg-gray-200 text-gray-700 w-8 h-8 sm:w-8 sm:h-8 rounded-full flex items-center justify-center"
          >
            <img
              class="w-4 h-4 sm:w-5 sm:h-5 object-contain"
              src="https://img.icons8.com/windows/32/gender-neutral-user.png"
              alt="Profile"
            />
          </a>
          <div class="relative" id="languageContainer">
            <button
              id="languageSelector"
              class="bg-gray-100 hover:bg-gray-200 text-gray-700 w-8 h-8 sm:w-8 sm:h-8 rounded-full flex items-center justify-center"
              aria-label="Change Language"
              aria-expanded="false"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 sm:w-5 sm:h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </button>
            <div
              id="languageDropdown"
              class="absolute right-0 mt-1 py-0.5 w-24 bg-white rounded-md shadow border border-gray-200 hidden"
            >
              <button
                class="w-full px-2 py-0.5 text-left text-xs hover:bg-gray-100 flex items-center gap-1"
                data-lang="en"
              >
                <span data-i18n="languages.en">English</span>
                <span class="ml-auto opacity-0" id="checkEn">✓</span>
              </button>
              <button
                class="w-full px-2 py-0.5 text-left text-xs hover:bg-gray-100 flex items-center gap-1"
                data-lang="de"
              >
                <span data-i18n="languages.de">Deutsch</span>
                <span class="ml-auto opacity-0" id="checkDe">✓</span>
              </button>
            </div>
          </div>
          <button
            id="settingsButton"
            class="bg-gray-100 hover:bg-gray-200 text-gray-700 w-8 h-8 sm:w-8 sm:h-8 rounded-full flex items-center justify-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 sm:w-5 sm:h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
          </button>
        </div>
      </header>

      <!-- Category Selection Modal Overlay -->
      <div
        id="modalOverlay"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
      >
        <div
          id="settingsPanel"
          class="bg-white border border-gray-200 rounded-xl shadow-lg p-4 w-11/12 max-w-md"
        >
          <h3 class="text-lg font-bold mb-2" data-i18n="settings.title">
            Settings
          </h3>
          <hr class="border-t border-gray-200 my-2" />
          <div class="mb-4">
            <h4
              class="font-bold text-md mb-1"
              data-i18n="settings.filterCategories"
            >
              Filter Categories
            </h4>
            <p
              class="text-xs text-gray-600 mb-3"
              data-i18n="settings.filterDescription"
            >
              Uncheck categories below to avoid getting questions for them. By
              default, all are enabled.
            </p>
            <div class="flex gap-2 flex-wrap">
              <div
                class="category-item selected cursor-pointer rounded-full border border-gray-200 px-2 py-1 text-center text-xs inline-flex items-center justify-center whitespace-nowrap"
                data-value="Philosophy"
              >
                Philosophy
              </div>
              <div
                class="category-item selected cursor-pointer rounded-full border border-gray-200 px-2 py-1 text-center text-xs inline-flex items-center justify-center whitespace-nowrap"
                data-value="AI & Future"
              >
                AI & Future
              </div>
              <div
                class="category-item selected cursor-pointer rounded-full border border-gray-200 px-2 py-1 text-center text-xs inline-flex items-center justify-center whitespace-nowrap"
                data-value="Personal Growth & Relationships"
              >
                Personal Growth & Relationships
              </div>
              <div
                class="category-item selected cursor-pointer rounded-full border border-gray-200 px-2 py-1 text-center text-xs inline-flex items-center justify-center whitespace-nowrap"
                data-value="Politics"
              >
                Politics
              </div>
              <div
                class="category-item selected cursor-pointer rounded-full border border-gray-200 px-2 py-1 text-center text-xs inline-flex items-center justify-center whitespace-nowrap"
                data-value="Ethics"
              >
                Ethics
              </div>
              <div
                class="category-item selected cursor-pointer rounded-full border border-gray-200 px-2 py-1 text-center text-xs inline-flex items-center justify-center whitespace-nowrap"
                data-value="Thought Experiments"
              >
                Thought Experiments
              </div>
              <div
                class="category-item selected cursor-pointer rounded-full border border-gray-200 px-2 py-1 text-center text-xs inline-flex items-center justify-center whitespace-nowrap"
                data-value="Business & Risk"
              >
                Business & Risk
              </div>
              <div
                class="category-item selected cursor-pointer rounded-full border border-gray-200 px-2 py-1 text-center text-xs inline-flex items-center justify-center whitespace-nowrap"
                data-value="Biases & Fallacies"
              >
                Biases & Fallacies
              </div>
              <div
                class="category-item selected cursor-pointer rounded-full border border-gray-200 px-2 py-1 text-center text-xs inline-flex items-center justify-center whitespace-nowrap"
                data-value="Fun & Casual"
              >
                Fun & Casual
              </div>
            </div>
          </div>
          <div id="categoriesError" class="text-red-500 mt-2 text-xs hidden">
            At least one category must be selected.
          </div>
          <div class="mt-4 text-right">
            <button
              id="closeCategories"
              class="bg-gray-800 text-white px-3 py-1 rounded-full text-sm hover:bg-gray-700 transition-colors"
              data-i18n="settings.done"
            >
              Done
            </button>
          </div>
        </div>
      </div>

      <!-- Slogan -->
      <div class="mb-4 space-y-2 md:space-y-6">
        <p class="text-xs md:text-lg text-black mb-6 text-center" data-i18n="main.slogan"></p>

        <!-- Demo Video Section with spacers (Only shown to first-time visitors) -->
        <div id="firstTimeVideoSection" class="hidden">
          <!-- Spacer above video -->
          <div style="height: 4px;"></div>

          <!-- Video container -->
          <div class="w-full flex justify-center mb-6">
            <div class="w-full max-w-3xl rounded-lg overflow-hidden shadow-lg">
              <div id="videoContainer" class="relative">
                <video
                  id="demoVideo"
                  class="w-full cursor-pointer"
                  preload="auto"
                  autoplay
                  muted
                  playsinline
                  poster="{{ url_for('static', filename='img/video_poster.webp') }}"
                >
                  <!-- High resolution for desktop -->
                  <source
                    media="(min-width: 768px)"
                    src="{{ url_for('static', filename='vid/demo.webm') }}"
                    type="video/webm"
                  />
                  <!-- Medium resolution for tablets -->
                  <source
                    media="(min-width: 480px)"
                    src="{{ url_for('static', filename='vid/demo_medium.webm') }}"
                    type="video/webm"
                  />
                  <!-- Low resolution for mobile -->
                  <source
                    src="{{ url_for('static', filename='vid/demo_mobile.webm') }}"
                    type="video/webm"
                  />
                  Your browser does not support the video tag.
                </video>
                <div class="video-hover-effect">❚❚</div>
                <div class="video-play-button hidden">▶</div>
                <div class="video-ended-button hidden">▶</div>
              </div>
            </div>
          </div>

          <!-- Spacer below video -->
          <div style="height: 2px;"></div>
        </div>

        <!-- Simple Links (visible on mobile and tablet) -->
        <div class="flex justify-center md:hidden">
          <div class="flex items-center justify-center w-full divide-x divide-gray-300">
            <a href="/how_it_works" class="text-gray-600 hover:text-gray-800 text-xs px-3 py-1 transition-colors text-center flex-1">
              <span data-i18n="main.howItWorks"></span>
            </a>
            <a href="/how_to_improve" class="text-gray-600 hover:text-gray-800 text-xs px-3 py-1 transition-colors text-center flex-1">
              <span data-i18n="main.howToImprove"></span>
            </a>
            <a href="/support" class="text-gray-600 hover:text-gray-800 text-xs px-3 py-1 transition-colors text-center flex-1">
              <span data-i18n="main.howToSupport"></span>
            </a>
          </div>
        </div>

        <!-- Desktop Cards (visible on larger screens) -->
        <div class="hidden md:grid md:grid-cols-3 gap-6 px-14">
          <!-- Platform Guide Card -->
          <div class="educational-card bg-white rounded-xl overflow-hidden">
            <div class="card-header bg-gray-800 text-white pl-2 pr-1 py-0.5 md:px-3 md:py-2">
              <h3 class="font-semibold text-[0.6rem] md:text-xs whitespace-normal break-words" data-i18n="main.howItWorks"></h3>
            </div>
            <div class="card-content p-1 md:p-2 flex flex-col h-full">
              <p class="text-[0.5rem] md:text-[0.7rem] text-gray-600 leading-tight break-words" data-i18n="cards.platformGuideDescription"></p>
              <a class="text-[0.5rem] md:text-[0.7rem] text-gray-800 font-medium hover:text-gray-600 transition-colors mt-auto" href="/how_it_works" data-i18n="cards.platformGuideLearnMore"></a>
            </div>
          </div>
          <!-- Reasoning Tips Card -->
          <div class="educational-card bg-white rounded-xl overflow-hidden">
            <div class="card-header bg-gray-800 text-white pl-2 pr-1 py-0.5 md:px-3 md:py-2">
              <h3 class="font-semibold text-[0.6rem] md:text-xs whitespace-normal break-words" data-i18n="main.howToImprove"></h3>
            </div>
            <div class="card-content p-1 md:p-2 flex flex-col h-full">
              <p class="text-[0.5rem] md:text-[0.7rem] text-gray-600 leading-tight break-words" data-i18n="cards.reasoningTipsDescription"></p>
              <a class="text-[0.5rem] md:text-[0.7rem] text-gray-800 font-medium hover:text-gray-600 transition-colors mt-auto" href="/how_to_improve" data-i18n="cards.reasoningTipsLearnMore"></a>
            </div>
          </div>
          <!-- How to Support Card -->
          <div class="educational-card bg-white rounded-xl overflow-hidden">
            <div class="card-header bg-gray-800 text-white pl-2 pr-1 py-0.5 md:px-3 md:py-2">
              <h3 class="font-semibold text-[0.6rem] md:text-xs whitespace-normal break-words" data-i18n="main.howToSupport"></h3>
            </div>
            <div class="card-content p-1 md:p-2 flex flex-col h-full">
              <p class="text-[0.5rem] md:text-[0.7rem] text-gray-600 leading-tight break-words" data-i18n="cards.howToSupportDescription"></p>
              <a class="text-[0.5rem] md:text-[0.7rem] text-gray-800 font-medium hover:text-gray-600 transition-colors mt-auto" href="/support" data-i18n="cards.howToSupportLearnMore"></a>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <main class="bg-white rounded-3xl p-2 md:p-4 mb-8">
        <!-- Question Section -->
        <!-- Step 1 indicator -->
        <div class="flex items-center mb-4">
          <div class="flex items-center justify-center w-5 h-5 rounded-full bg-gray-100 mr-2">
            <span class="text-gray-500 text-xs font-medium">1</span>
          </div>
          <span class="text-gray-500 text-xs font-medium" data-i18n="steps.chooseQuestion">Choose Question</span>
        </div>
        <!-- Category badge above the question -->
        <div class="mb-2">
          <span id="categoryBadge" class="bg-gray-700 text-white px-3 py-1.5 rounded-full text-xs md:text-sm break-words max-w-full inline-block category-badge"></span>
        </div>
        <div class="flex flex-col md:flex-row items-start mb-0">
          <h2
            id="questionDescription"
            class="text-2xl md:text-3xl font-bold flex-1"
          ></h2>
          <div
            class="flex flex-col items-start md:ml-6 md:items-end mt-4 md:mt-0"
          >
            <button
              id="rerollButton"
              class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-full font-medium flex items-center space-x-1"
              data-i18n="main.buttons.randomQuestion"
            >
              <svg
                class="w-4 h-4"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Random Question</span>
            </button>
            <button
              id="selectQuestionButton"
              class="mt-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-full font-medium flex items-center space-x-1"
              data-i18n="main.buttons.selectQuestion"
            >
              <svg
                class="w-4 h-4"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Select Question</span>
            </button>
            {% if user and user.tier == "pro" %}
            <button
              id="writeQuestionButton"
              class="mt-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-full font-medium flex items-center space-x-1"
              data-i18n="main.buttons.writeQuestion"
            >
              <svg
                class="w-4 h-4"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  d="M12 4v16m8-8H4"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Write Question</span>
            </button>
            {% endif %}
          </div>
        </div>

        <!-- Fixed spacing div -->
        <div class="h-8"></div>

        <!-- Step 2 indicator -->
        <div class="flex items-center mt-0 mb-2">
          <div class="flex items-center justify-center w-5 h-5 rounded-full bg-gray-100 mr-2">
            <span class="text-gray-500 text-xs font-medium">2</span>
          </div>
          <span class="text-gray-500 text-xs font-medium" data-i18n="steps.answerQuestion">Answer Question</span>
        </div>

        <!-- Toggle for Input Mode -->
        <div class="mb-4 flex border-b border-gray-200">
          <button
            id="textModeTab"
            class="input-mode-tab flex-1 px-4 py-2 text-sm text-gray-600 hover:text-gray-800 font-medium flex items-center justify-center space-x-2 transition-colors active"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
            <span data-i18n="main.inputModes.write">Write</span>
          </button>
          <button
            id="voiceModeTab"
            class="input-mode-tab flex-1 px-4 py-2 text-sm text-gray-500 hover:text-gray-800 font-medium flex items-center justify-center space-x-2 transition-colors"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
              />
            </svg>
            <span data-i18n="main.inputModes.speak">Speak</span>
          </button>
        </div>

        <!-- Text Input Section (Default Mode) -->
        <div id="textInputSection">
          <div class="space-y-4">
            <div>
              <label
                data-i18n="main.inputLabels.claim"
                class="block text-lg font-bold mb-2"
              >
                Your Claim
              </label>
              <textarea
                id="claimInput"
                class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-gray-700 h-32"
                data-i18n-placeholder="main.inputLabels.claimDescription"
                maxlength="{{ char_limits.claim }}"
              ></textarea>
              <div class="mt-1 text-sm text-gray-500">
                <span data-i18n="challenge.charactersRemaining"
                  >Characters remaining:</span
                >
                <span id="claimCount">{{ char_limits.claim }}</span>
              </div>
            </div>

            <div>
              <label
                data-i18n="main.inputLabels.reasoning"
                class="block text-lg font-bold mb-2"
              >
                Your Reasoning
              </label>
              <textarea
                id="argumentInput"
                class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-gray-700 h-32"
                data-i18n-placeholder="main.inputLabels.reasoningDescription"
                maxlength="{{ char_limits.argument }}"
              ></textarea>
              <div class="mt-1 text-sm text-gray-500">
                <span data-i18n="challenge.charactersRemaining"
                  >Characters remaining:</span
                >
                <span id="argumentCount">{{ char_limits.argument }}</span>
              </div>
            </div>

            <div>
              <label
                data-i18n="main.inputLabels.counterargument"
                class="block text-lg font-bold mb-2"
              >
                Counterargument (Optional)
              </label>
              <textarea
                id="counterargumentInput"
                class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-gray-700 h-32"
                data-i18n-placeholder="main.inputLabels.counterargumentDescription"
                maxlength="{{ char_limits.counterargument }}"
              ></textarea>
              <div class="mt-1 text-sm text-gray-500">
                <span data-i18n="challenge.charactersRemaining"
                  >Characters remaining:</span
                >
                <span id="counterargumentCount">{{ char_limits.counterargument }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Voice Input Section (Initially Hidden) -->
        <div id="voiceInputSection" style="display: none" class="mt-0">
          <div class="mb-6">
            <div class="flex flex-col items-center">
              <div class="flex flex-col items-center w-full mt-4">
                <div class="flex justify-center w-full">
                  <button
                    id="recordButton"
                    class="w-14 h-14 bg-white border-2 border-gray-800 rounded-full flex items-center justify-center hover:bg-gray-50 transition-all duration-200"
                  >
                    <svg
                      class="w-8 h-8"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                      />
                    </svg>
                  </button>
                </div>

                <!-- Fixed height container for status and timer -->
                <div
                  class="mt-2 text-center h-[3.5rem] flex flex-col justify-center w-full"
                >
                  <div
                    id="recordingStatus"
                    class="text-sm font-medium text-gray-600 min-h-[1.5rem]"
                  ></div>
                  <div
                    id="recordingTimer"
                    class="mt-1 font-mono text-sm text-gray-500 hidden min-h-[1.25rem]"
                  >
                    <span id="timerDisplay">0:00</span>
                    <span class="mx-1">/</span>
                    <span id="maxRecordingTime"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <label
              for="voiceTranscript"
              class="block text-lg font-bold"
              data-i18n="main.voiceInput.recordedAnswer"
            >
              Your Recorded Answer
            </label>
            <textarea
              id="voiceTranscript"
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-gray-700 h-32"
              data-i18n-placeholder="main.voiceInput.transcriptPlaceholder"
            ></textarea>
            <div class="mt-1 text-sm text-gray-500">
              <span data-i18n="main.voiceInput.charactersRemaining"
                >Characters remaining:</span
              >
              <span id="voiceCount"></span>
            </div>
          </div>
        </div>

        <!-- Moved Error Message Above the Submit Button -->
        <div class="mt-4">
          <div id="errorMessage" class="text-sm text-red-500 mb-1"></div>
          <div class="flex justify-between items-center">
            <button
              id="submitAnswer"
              class="bg-gray-800 text-white px-6 py-2 rounded-full hover:bg-gray-700 transition-colors"
              data-i18n="challenge.submit"
            >
              Submit
            </button>
          </div>
        </div>
      </main>

      <!-- Evaluation Results -->
      <div id="evaluationResults" class="hidden bg-white p-8">
        <h2 class="text-2xl font-bold mb-6" data-i18n="evaluation.title">
          Evaluation
        </h2>
        <div id="overallEvaluation" class="mb-6"></div>
        <div id="scores" class="grid gap-4 mb-8">
          <div class="score-item">
            <span data-i18n="evaluation.scores.logic">Logical Structure</span>
          </div>
          <div class="score-item">
            <span data-i18n="evaluation.scores.clarity">Clarity</span>
          </div>
          <div class="score-item">
            <span data-i18n="evaluation.scores.depth">Depth</span>
          </div>
          <div class="score-item">
            <span data-i18n="evaluation.scores.objectivity">Objectivity</span>
          </div>
          <div class="score-item">
            <span data-i18n="evaluation.scores.creativity">Creativity</span>
          </div>
          <div class="score-item">
            <span data-i18n="evaluation.scores.relevance">Relevance</span>
          </div>
        </div>
        <!-- XP and Level Info Section -->
        <div id="xpInfo" class="mt-4 text-center profile-xp">
          <!-- Updated error/message paragraphs with inline style overriding left text-align -->
          <p
            id="xpMessage"
            class="text-sm text-red-600 text-center"
            style="text-align: center; padding-left: 0"
          ></p>
          <p
            id="levelUpMessage"
            class="text-green-600 font-bold text-center"
            data-i18n="evaluation.levelUp"
            style="text-align: center; padding-left: 0"
          ></p>
          <p>
            <span data-i18n="evaluation.experiencePoints">
              Experience Points Gained:
            </span>
            <span id="xpGained"><strong>0</strong></span>
          </p>
          <!-- Two-column layout: left column for level image, right column for username, level name, XP bar and progress info -->
          <div class="flex items-center justify-center">
            <!-- Left column: level image with number indicator -->
            <div class="level-image-wrapper">
              {% set variant = "xp" %} {% set show_text = false %} {% include
              'partials/level_indicator.html' %}
              <!-- Circular level number indicator -->
              <div class="level-number-indicator">
                {{ level_info.level_number }}
              </div>
            </div>
            <!-- Right column: username, level name, XP bar and progress info -->
            <div class="flex flex-col text-left">
              <p class="text-sm text-gray-600 mb-0 move-down">
                {{ current_user.username if current_user.is_authenticated else
                'Anonymous' }}
              </p>
              <p class="text-base mb-0 move-down" id="currentLevel">
                <strong>{{ level_info.display_name }}</strong>
              </p>
              <div class="xp-bar-wrapper mt-2">
                <div class="xp-bar-container">
                  <div
                    class="xp-progress-bar bg-green-500 h-full transition-all duration-500"
                    {% set progress_width = level_info.progress_percent|string + '%' %}
                    style="width: {{ progress_width }}"
                  ></div>
                </div>
                <p class="text-sm mt-1">
                  <span data-i18n="evaluation.progress">Progress:</span>
                  <span id="xpProgressText">0 / 0</span> XP
                </p>
                <p class="text-sm mt-1">
                  <span data-i18n="evaluation.nextLevel">Next Level:</span>
                  <span id="nextLevel">Level 2 (Inquisitive Mind)</span>
                </p>
              </div>
            </div>
          </div>

          <!-- Achievements Section -->
          <div class="mt-8 text-center">
            <h5 class="text-lg font-bold mb-4">
              <span data-i18n="profile.achievements">Achievements</span>
              <span class="text-gray-600 font-normal achievements-count">
                ({{ earned_achievements|length }}/{{ all_achievements|length }})
              </span>
            </h5>
            <div class="flex justify-center w-full">
              <div
                class="inline-grid grid-cols-5 sm:grid-cols-7 md:grid-cols-9 lg:grid-cols-[repeat(19,minmax(0,40px))] justify-center justify-items-center gap-x-4 gap-y-2 mb-8 max-w-4xl mx-auto px-4"
              >
                {% for achievement in all_achievements %} {% set is_achieved =
                achievement.id in earned_achievements %}
                <div class="group relative">
                  <div
                    data-achievement-id="{{ achievement.id }}"
                    class="achievement-icon w-10 h-10 flex items-center justify-center rounded-lg border-2 {{ 'border-gray-200' if not is_achieved else 'border-gray-600' }} bg-white {{ 'opacity-40' if not is_achieved else '' }} transition-all duration-300 hover:border-gray-400"
                  >
                    {% if achievement.icon == "trophy" %}
                    <img
                      src="{{ url_for('static', filename='img/trophy.webp') }}"
                      class="w-6 h-6 {{ 'opacity-30' if not is_achieved else '' }}"
                      alt="Trophy"
                    />
                    {% endif %}
                  </div>
                  <!-- Tooltip -->
                  <div
                    class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 absolute z-10 w-48 left-1/2 -translate-x-1/2 translate-y-2 pointer-events-none bg-gray-800 text-white text-sm rounded-lg p-2 shadow-lg"
                  >
                    <p class="font-bold mb-1" data-i18n="{{ achievement.name_key }}">{{ achievement.name }}</p>
                    <p class="text-gray-200 text-xs" data-i18n="{{ achievement.description_key }}">{{ achievement.description }}</p>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <script>
            // Dispatch event to trigger achievement tooltip positioning
            document.addEventListener('DOMContentLoaded', function() {
              setTimeout(function() {
                document.dispatchEvent(new CustomEvent('achievementsLoaded'));
              }, 100); // Small delay to ensure DOM is fully rendered
            });
          </script>

        <!-- Additional instructions/link to the profile page -->
        <div class="mt-2 text-center">
          <p class="text-sm text-center">
            <span data-i18n="evaluation.checkProfile">Check your</span>
            <a
              href="/profile"
              class="inline-flex items-baseline text-gray-800 underline hover:text-gray-600"
            >
              <img
                src="https://img.icons8.com/windows/32/gender-neutral-user.png"
                alt="Profile"
                class="w-4 h-4 mr-1 relative top-0.5"
              />
              <span data-i18n="evaluation.profilePage">Profile Page</span>
            </a>
            <span data-i18n="evaluation.reviewProgress"
              >to review answered questions and track your progress.</span
            >
          </p>
        </div>

        {% if not current_user.is_authenticated %}
        <div
          class="mt-4 mb-4 max-w-full md:w-max mx-auto bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-2 rounded text-sm"
        >
          <span data-i18n="evaluation.notLoggedIn"></span>
          <a
            href="#"
            onclick="showAuthModal()"
            class="text-gray-800 underline hover:text-gray-600"
            ><span data-i18n="evaluation.here"></span></a
          ><span data-i18n="evaluation.loginSuffix"></span>
        </div>
        {% endif %}
        <!-- New Challenge Response Section -->
        <div
          id="challengeSection"
          class="hidden mt-8 p-8 bg-white border-2 border-gray-200 rounded-lg shadow-sm"
          style="box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1)"
        >
          <div class="flex items-center gap-2 mb-4">
            <div
              class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center"
            >
              ⚔️
            </div>
            <h2 class="text-2xl font-bold" data-i18n="challenge.title">
              Challenge
            </h2>
          </div>
          <p id="challengeText" class="mb-4 text-gray-700"></p>

          <!-- Toggle for Challenge Input Mode -->
          <div class="mt-4 mb-6 flex border-b border-gray-200">
            <button
              id="challengeTextModeTab"
              class="input-mode-tab flex-1 px-4 py-2 text-sm text-gray-600 hover:text-gray-800 font-medium flex items-center justify-center space-x-2 transition-colors active"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                />
              </svg>
              <span data-i18n="main.inputModes.write">Write</span>
            </button>
            <button
              id="challengeVoiceModeTab"
              class="input-mode-tab flex-1 px-4 py-2 text-sm text-gray-500 hover:text-gray-800 font-medium flex items-center justify-center space-x-2 transition-colors"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                />
              </svg>
              <span data-i18n="main.inputModes.speak">Speak</span>
            </button>
          </div>

          <!-- Challenge Text Input Section (Default Mode) -->
          <div id="challengeTextInputSection">
            <div>
              <label
                for="challengeResponseInput"
                class="block text-lg font-bold mb-2"
                data-i18n="challenge.responseLabel"
                >Your Response</label
              >
              <textarea
                id="challengeResponseInput"
                class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-gray-700 h-32"
                data-i18n-placeholder="main.inputLabels.challengeDescription"
                maxlength="{{ char_limits.challenge }}"
              ></textarea>
              <div class="mt-1 text-sm text-gray-500">
                <span data-i18n="challenge.charactersRemaining"
                  >Characters remaining:</span
                >
                <span id="challengeCount">{{ char_limits.challenge }}</span>
              </div>
            </div>
          </div>

          <!-- Challenge Voice Input Section -->
          <div id="challengeVoiceInputSection" style="display: none" class="mt-0">
            <div class="mb-6">
              <div class="flex justify-center items-center w-full">
                <div class="flex flex-col items-center">
                  <button
                    id="challengeRecordButton"
                    class="w-14 h-14 bg-white border-2 border-gray-800 rounded-full flex items-center justify-center hover:bg-gray-50 transition-all duration-200"
                  >
                    <svg
                      class="w-8 h-8"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                      />
                    </svg>
                  </button>

                  <!-- Fixed height container for status and timer -->
                  <div class="mt-2 text-center h-[3.5rem] flex flex-col justify-center">
                    <div
                      id="challengeRecordingStatus"
                      class="text-sm font-medium text-gray-600 min-h-[1.5rem]"
                    ></div>
                    <div
                      id="challengeRecordingTimer"
                      class="mt-1 font-mono text-sm text-gray-500 hidden min-h-[1.25rem]"
                    >
                      <span id="challengeTimerDisplay">0:00</span>
                      <span class="mx-1">/</span>
                      <span id="challengeMaxRecordingTime"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="space-y-4">
              <label
                for="challengeVoiceTranscript"
                class="block text-lg font-bold"
                data-i18n="main.voiceInput.recordedAnswer"
              >
                Your Recorded Answer
              </label>
              <textarea
                id="challengeVoiceTranscript"
                class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-gray-700 h-32"
                data-i18n-placeholder="main.voiceInput.transcriptPlaceholder"
                maxlength="{{ char_limits.voice }}"
              ></textarea>
              <div class="mt-1 text-sm text-gray-500">
                <span data-i18n="challenge.charactersRemaining">Characters remaining:</span>
                <span id="challengeVoiceCount">{{ char_limits.voice }}</span>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <div
              id="challengeErrorMessage"
              class="text-sm text-red-500 mb-1"
            ></div>
            <button
              id="submitChallengeResponse"
              class="bg-gray-800 text-white px-6 py-2 rounded-full hover:bg-gray-700 transition-colors"
              data-i18n="challenge.submit"
            >
              Submit
            </button>
          </div>

          <!-- Container for displaying challenge evaluation feedback -->
          <div id="challengeEvaluationResults" class="mt-8 hidden bg-white p-8">
            <h2 class="text-2xl font-bold mb-6" data-i18n="evaluation.title">
              Evaluation
            </h2>
            <div id="challengeOverallEvaluation" class="mb-6"></div>
            <div id="challengeScores" class="grid gap-4 mb-8">
              <div class="score-item">
                <span data-i18n="evaluation.scores.logic">Logical Structure</span>
              </div>
              <div class="score-item">
                <span data-i18n="evaluation.scores.clarity">Clarity</span>
              </div>
              <div class="score-item">
                <span data-i18n="evaluation.scores.depth">Depth</span>
              </div>
              <div class="score-item">
                <span data-i18n="evaluation.scores.objectivity">Objectivity</span>
              </div>
              <div class="score-item">
                <span data-i18n="evaluation.scores.creativity">Creativity</span>
              </div>
              <div class="score-item">
                <span data-i18n="evaluation.scores.relevance">Relevance</span>
              </div>
            </div>

            <!-- XP and Level Info Section for Challenge -->
            <div id="challengeXpInfo" class="mt-4 text-center profile-xp">
              <p
                id="challengeXpMessage"
                class="text-sm text-red-600 text-center"
                style="text-align: center; padding-left: 0"
              ></p>
              <p
                id="challengeLevelUpMessage"
                class="text-green-600 font-bold text-center"
                data-i18n="evaluation.levelUp"
                style="text-align: center; padding-left: 0"
              ></p>
              <p>
                <span data-i18n="evaluation.experiencePoints">
                  Experience Points Gained:
                </span>
                <span id="challengeXpGained"><strong>0</strong></span>
              </p>

              <!-- Two-column layout: left column for level image, right column for username, level name, XP bar and progress info -->
              <div class="flex items-center justify-center">
                <!-- Left column: level image with number indicator -->
                <div class="level-image-wrapper">
                  {% set variant = "xp" %} {% set show_text = false %}
                  {% include 'partials/level_indicator.html' %}
                  <!-- Circular level number indicator -->
                  <div class="level-number-indicator">
                    {{ level_info.level_number }}
                  </div>
                </div>

                <!-- Right column: username, level name, XP bar and progress info -->
                <div class="flex flex-col text-left">
                  <p class="text-sm text-gray-600 mb-0 move-down">
                    {{ current_user.username if current_user.is_authenticated
                    else 'Anonymous' }}
                  </p>
                  <p
                    class="text-base mb-0 move-down"
                    id="challengeCurrentLevel"
                  >
                    <strong>{{ level_info.display_name }}</strong>
                  </p>
                  <div class="xp-bar-wrapper mt-2">
                    <div class="xp-bar-container">
                      <div
                        class="xp-progress-bar bg-green-500 h-full transition-all duration-500"
                        {% set progress_width = level_info.progress_percent|string + '%' %}
                        style="width: {{ progress_width }}"
                      ></div>
                    </div>
                    <p class="text-sm mt-1">
                      <span data-i18n="evaluation.progress">Progress:</span>
                      <span id="challengeXpProgressText">{{ level_info.xp_into_level }} / {{ level_info.xp_needed }}</span> XP
                    </p>
                    <p class="text-sm mt-1">
                      <span data-i18n="evaluation.nextLevel">Next Level:</span>
                      <span id="challengeNextLevel">{{ level_info.next_level }}</span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Next Question Button -->
        <div class="mt-6 text-center">
          <button
            id="nextQuestion"
            class="bg-gray-800 text-white px-6 py-2 rounded-full hover:bg-gray-700 transition-colors"
            data-i18n="challenge.tryAnother"
          >
            Try Another Question
          </button>
        </div>
      </div>

      <div
        id="questionSelectionOverlay"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
      >
        <div
          class="bg-white border border-gray-200 rounded-xl shadow-lg p-4 w-11/12 max-w-2xl"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold" data-i18n="questionSelection.title">
              Select a Question
            </h3>
            <button
              id="closeQuestionSelection"
              class="bg-gray-800 text-white px-3 py-1 rounded-full text-sm"
              data-i18n="questionSelection.close"
            >
              ✕
            </button>
          </div>
          <div id="questionList" class="max-h-96 overflow-y-auto">
            <!-- List of questions will be dynamically populated here -->
          </div>
        </div>
      </div>

      <div
        id="writeQuestionOverlay"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
      >
        <div
          class="bg-white border border-gray-200 rounded-xl shadow-lg p-4 w-11/12 max-w-2xl"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold" data-i18n="writeQuestion.title">
              Write Your Own Question
            </h3>
            <button
              id="closeWriteQuestion"
              class="bg-gray-800 text-white px-3 py-1 rounded-full text-sm"
              data-i18n="writeQuestion.close"
            >
              ✕
            </button>
          </div>
          <div class="mb-4">
            <textarea
              id="customQuestion"
              class="w-full p-2 border border-gray-300 rounded-md"
              rows="3"
              data-i18n-placeholder="writeQuestion.label"
              maxlength="200"
            ></textarea>
            <div class="text-xs text-gray-500 mt-1" data-i18n="writeQuestion.hint">
              Write a clear question that can be argued from multiple perspectives.
            </div>
          </div>
          <div class="flex justify-end">
            <button
              id="submitCustomQuestion"
              class="bg-gray-600 hover:bg-gray-800 text-white px-4 py-2 rounded-md text-sm font-medium"
              data-i18n="writeQuestion.submit"
            >
              Use This Question
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Include custom JavaScript -->
    <script type="module" src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script>
      // Make showAuthModal globally available with proper Google auth handling
      window.showAuthModal = function() {
        // Check if showLoginModal is available directly or on window
        if (typeof showLoginModal === 'function') {
          showLoginModal();
        } else if (window.showLoginModal) {
          window.showLoginModal();
        } else {
          // Fallback approach - create a simple login modal that redirects to login page
          const modal = document.createElement("div");
          modal.innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
                 onclick="event.target === this && this.remove()">
              <div class="bg-white rounded-lg p-6 w-full max-w-md relative"
                   onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-semibold">Login</h3>
                  <button onclick="this.parentElement.parentElement.parentElement.remove(); event.stopPropagation()"
                          class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="space-y-4">
                  <p>Please log in to continue and access higher usage limits.</p>
                  <div class="flex justify-center">
                    <a href="/login" class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-700 text-center">
                      Go to Login Page
                    </a>
                  </div>
                </div>
              </div>
            </div>
          `;

          // Remove any existing modals
          document.querySelectorAll("div.fixed.inset-0").forEach((el) => el.remove());
          document.body.appendChild(modal);
        }
      };

      // Ensure showAuthModal is available for the load event handler
      document.addEventListener('DOMContentLoaded', function() {
        if (!window.showAuthModal) {
          window.showAuthModal = function() {
            window.location.href = '/login';
          };
        }
      });
    </script>

    <!-- Feedback Modal -->
    <div
      id="feedbackModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center"
    >
      <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
        <h3
          class="text-xl font-bold mb-4"
          data-i18n="supportPage.feedbackModal.title"
        ></h3>
        <form id="feedbackForm" class="space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-gray-700 mb-1"
              data-i18n="supportPage.feedbackModal.categoryLabel"
            ></label>
            <select
              id="feedbackCategory"
              class="w-full rounded-lg border border-gray-300 px-3 py-2"
            >
              <option
                value="general"
                data-i18n="supportPage.feedbackModal.categoryOptions.general"
              ></option>
              <option
                value="feature"
                data-i18n="supportPage.feedbackModal.categoryOptions.feature"
              ></option>
              <option
                value="bug"
                data-i18n="supportPage.feedbackModal.categoryOptions.bug"
              ></option>
            </select>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 mb-1"
              data-i18n="supportPage.feedbackModal.messageLabel"
            ></label>
            <textarea
              id="feedbackMessage"
              rows="4"
              class="w-full rounded-lg border border-gray-300 px-3 py-2"
              data-i18n-placeholder="supportPage.feedbackModal.messagePlaceholder"
            ></textarea>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 mb-1"
              data-i18n="supportPage.feedbackModal.emailLabel"
            ></label>
            <input
              type="email"
              id="feedbackEmail"
              class="w-full rounded-lg border border-gray-300 px-3 py-2"
              data-i18n-placeholder="supportPage.feedbackModal.emailPlaceholder"
            />
            <p class="text-xs text-gray-500 mt-1" data-i18n="supportPage.feedbackModal.emailOptional"></p>
          </div>
          <div class="flex justify-end gap-2">
            <button
              type="button"
              onclick="hideFeedbackModal()"
              class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800"
              data-i18n="supportPage.feedbackModal.cancelButton"
            ></button>
            <button
              type="submit"
              id="feedbackSubmitButton"
              class="px-4 py-2 text-sm bg-gray-800 text-white rounded-full hover:bg-gray-700"
              data-i18n="supportPage.feedbackModal.submitButton"
            ></button>
          </div>
          <div id="feedbackLoading" class="mt-3 hidden">
            <div class="flex items-center justify-center">
              <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-800"></div>
              <span class="ml-2 text-sm text-gray-600" data-i18n="supportPage.feedbackModal.loadingMessage">Submitting feedback...</span>
            </div>
          </div>
        </form>
        <div
          id="feedbackSuccess"
          class="mt-3 text-green-600 text-sm hidden"
          data-i18n="supportPage.feedbackModal.successMessage"
        ></div>
      </div>
    </div>

    <script>
      function showFeedbackModal() {
        document.getElementById("feedbackModal").classList.remove("hidden");
        // Apply translations to select options since they don't get updated automatically
        const currentLanguage = localStorage.getItem("language") || "en";
        fetch(`/static/translations/${currentLanguage}.json`)
          .then((response) => response.json())
          .then((translations) => {
            document
              .querySelectorAll("#feedbackCategory option")
              .forEach((option) => {
                const key = option.getAttribute("data-i18n");
                const translation = key
                  .split(".")
                  .reduce((obj, k) => obj && obj[k], translations);
                if (translation) {
                  option.textContent = translation;
                }
              });
          });
      }

      function hideFeedbackModal() {
        document.getElementById("feedbackModal").classList.add("hidden");
        document.getElementById("feedbackForm").classList.remove("hidden");
        document.getElementById("feedbackSuccess").classList.add("hidden");
        document.getElementById("feedbackSuccess").innerHTML = "";

        // Reset form state
        const submitButton = document.getElementById("feedbackSubmitButton");
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.classList.remove("opacity-50", "cursor-not-allowed");
        }

        const loadingElement = document.getElementById("feedbackLoading");
        if (loadingElement) {
          loadingElement.classList.add("hidden");
        }
      }

      // Close modal when clicking outside
      document
        .getElementById("feedbackModal")
        .addEventListener("click", (e) => {
          if (e.target === e.currentTarget) {
            hideFeedbackModal();
          }
        });

      document
        .getElementById("feedbackForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const message = document
            .getElementById("feedbackMessage")
            .value.trim();
          const category = document.getElementById("feedbackCategory").value;
          const email = document.getElementById("feedbackEmail").value.trim();
          const submitButton = document.getElementById("feedbackSubmitButton");
          const loadingElement = document.getElementById("feedbackLoading");

          if (!message) {
            document.getElementById("feedbackSuccess").innerHTML = `
            <p class="text-red-600">${
              window.translations?.supportPage?.feedbackModal?.errorMessage ||
              "Please enter your feedback message"
            }</p>
          `;
            document
              .getElementById("feedbackSuccess")
              .classList.remove("hidden");
            return;
          }

          try {
            // Disable submit button and show loading indicator
            submitButton.disabled = true;
            submitButton.classList.add("opacity-50", "cursor-not-allowed");
            loadingElement.classList.remove("hidden");

            const response = await fetch("/submit_feedback", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ message, category, email }),
            });

            // Hide loading indicator
            loadingElement.classList.add("hidden");

            const data = await response.json();

            if (response.ok) {
              document.getElementById("feedbackForm").classList.add("hidden");
              document.getElementById("feedbackSuccess").innerHTML = `
              <p class="mb-4">${
                window.translations?.supportPage?.feedbackModal
                  ?.successMessage || "Thanks for the feedback!"
              }</p>
              <div class="flex justify-end">
                <button onclick="hideFeedbackModal()" class="px-4 py-2 text-sm bg-gray-800 text-white rounded-full hover:bg-gray-700">
                  ${
                    window.translations?.supportPage?.feedbackModal
                      ?.cancelButton || "Close"
                  }
                </button>
              </div>
            `;
              document
                .getElementById("feedbackSuccess")
                .classList.remove("hidden");
              document.getElementById("feedbackMessage").value = "";
              document.getElementById("feedbackEmail").value = "";

              // Re-enable submit button after delay
              setTimeout(() => {
                submitButton.disabled = false;
                submitButton.classList.remove("opacity-50", "cursor-not-allowed");
              }, 2000);
            } else {
              // Re-enable submit button on error
              submitButton.disabled = false;
              submitButton.classList.remove("opacity-50", "cursor-not-allowed");

              document.getElementById("feedbackSuccess").innerHTML = `
              <p class="text-red-600">${
                data.error ||
                window.translations?.errors?.unexpectedError ||
                "Failed to submit feedback"
              }</p>
            `;
              document
                .getElementById("feedbackSuccess")
                .classList.remove("hidden");
            }
          } catch (error) {
            // Re-enable submit button on error
            submitButton.disabled = false;
            submitButton.classList.remove("opacity-50", "cursor-not-allowed");
            loadingElement.classList.add("hidden");

            console.error("Error:", error);
            document.getElementById("feedbackSuccess").innerHTML = `
            <p class="text-red-600">${
              window.translations?.errors?.unexpectedError ||
              "Failed to submit feedback"
            }</p>
          `;
            document
              .getElementById("feedbackSuccess")
              .classList.remove("hidden");
          }
        });
    </script>

    <!-- First-time visitor video script -->
    <script>
      // Function to hide the first-time video section
      function hideFirstTimeVideo() {
        const videoSection = document.getElementById('firstTimeVideoSection');
        if (videoSection && !videoSection.classList.contains('hidden')) {
          // Add a fade-out effect
          videoSection.style.transition = 'opacity 0.5s ease-out';
          videoSection.style.opacity = '0';

          // After the fade-out animation, hide the element completely
          setTimeout(() => {
            videoSection.classList.add('hidden');
            videoSection.style.opacity = '1'; // Reset opacity for future use if needed
          }, 500);

          // Stop the video if it's playing
          const demoVideo = document.getElementById('demoVideo');
          if (demoVideo && !demoVideo.paused) {
            demoVideo.pause();
          }

          // Always mark as visited when hiding the video
          localStorage.setItem('hasVisitedBefore', 'true');
        }
      }

      document.addEventListener("DOMContentLoaded", function() {
        // Check if this is the first visit
        const hasVisitedBefore = localStorage.getItem('hasVisitedBefore');

        // Get the referrer to check if we came from a language redirect
        const referrer = document.referrer;
        const currentUrl = window.location.href;

        // Extract domains to compare
        const getReferrerDomain = () => {
          try {
            const url = new URL(referrer);
            return url.hostname;
          } catch {
            return null;
          }
        };

        const getCurrentDomain = () => {
          try {
            const url = new URL(currentUrl);
            return url.hostname;
          } catch {
            return null;
          }
        };

        // Check if the current path has a language prefix
        const hasLanguagePrefix = () => {
          const pathSegments = window.location.pathname.split('/').filter(Boolean);
          return ['en', 'de'].includes(pathSegments[0]);
        };

        // Check if the referrer is from the same site and was a language route
        const referrerDomain = getReferrerDomain();
        const currentDomain = getCurrentDomain();
        const isLanguageRedirectClientSide = referrerDomain === currentDomain &&
          (/^\/(en|de)(\/|$)/.test(new URL(referrer).pathname) ||
           /^\/(en|de)(\/|$)/.test(window.location.pathname));

        // Check for language redirect flags
        const isLanguageRedirectServerSide = document.documentElement.getAttribute('data-language-redirect') === 'true';
        const isLanguageRedirectSession = sessionStorage.getItem('isLanguageRedirect') === 'true';

        // If there was a language redirect in the session, clear it for future navigation
        if (isLanguageRedirectSession) {
          sessionStorage.removeItem('isLanguageRedirect');
        }

        // Check if we are accessing the site through a language URL for the first time
        const isFirstTimeLanguageAccess = hasLanguagePrefix() && !hasVisitedBefore;

        // Use any of the detection methods
        const isLanguageRedirect = isLanguageRedirectClientSide || isLanguageRedirectServerSide || isLanguageRedirectSession;

        // Show the video if:
        // 1. User has never visited before (hasVisitedBefore is null/false)
        if (!hasVisitedBefore) {
          // First time visitor - show the video section
          const videoSection = document.getElementById('firstTimeVideoSection');
          if (videoSection) {
            videoSection.classList.remove('hidden');

            // Mark as visited for future visits, but only if:
            // - It's not a language redirect OR
            // - We're not directly accessing through a language URL for the first time
            // This ensures that visiting /de or /en directly won't immediately mark as visited
            if (!isLanguageRedirect && !isFirstTimeLanguageAccess) {
              localStorage.setItem('hasVisitedBefore', 'true');
            }

            // If this is a first-time language access, we'll set the visited flag after video interaction
            if (isFirstTimeLanguageAccess) {
              // Add listeners to set hasVisitedBefore on video interaction
              const demoVideo = document.getElementById('demoVideo');
              const submitButton = document.getElementById('submitAnswer');

              // Set visited when user interacts with the page meaningfully
              if (submitButton) {
                submitButton.addEventListener('click', function() {
                  localStorage.setItem('hasVisitedBefore', 'true');
                });
              }

              // Set visited when video is played, paused, or ended
              if (demoVideo) {
                demoVideo.addEventListener('play', function() {
                  localStorage.setItem('hasVisitedBefore', 'true');
                });

                demoVideo.addEventListener('pause', function() {
                  localStorage.setItem('hasVisitedBefore', 'true');
                });

                demoVideo.addEventListener('ended', function() {
                  localStorage.setItem('hasVisitedBefore', 'true');
                });
              }
            }

            // Set up video functionality
            const demoVideo = document.getElementById('demoVideo');
            const videoContainer = document.getElementById('videoContainer');
            const playButton = document.querySelector('.video-play-button');
            const endedButton = document.querySelector('.video-ended-button');
            const hoverEffect = document.querySelector('.video-hover-effect');

            if (demoVideo && videoContainer) {
              // Function to toggle play/pause
              const togglePlayPause = () => {
                if (demoVideo.paused) {
                  // Try to play and handle any autoplay restrictions
                  const playPromise = demoVideo.play();

                  if (playPromise !== undefined) {
                    playPromise
                      .then(() => {
                        // Video started playing
                        playButton.classList.add("hidden");
                        endedButton.classList.add("hidden");
                        videoContainer.classList.remove("video-needs-interaction");
                      })
                      .catch((error) => {
                        console.log("Autoplay prevented:", error);
                        // Add a visual indicator that user interaction is needed
                        videoContainer.classList.add("video-needs-interaction");
                      });
                  }
                } else {
                  // Pause the video
                  demoVideo.pause();
                  playButton.classList.remove("hidden");
                }
              };

              // Add click event to toggle play/pause when clicked on video
              demoVideo.addEventListener("click", togglePlayPause);

              // Add click event to hover effect element
              if (hoverEffect) {
                hoverEffect.addEventListener("click", (e) => {
                  e.stopPropagation(); // Prevent the click from reaching the video
                  togglePlayPause();
                });
              }

              // Add click events to play and ended buttons
              if (playButton) {
                playButton.addEventListener("click", (e) => {
                  e.stopPropagation();
                  togglePlayPause();
                });
              }

              if (endedButton) {
                endedButton.addEventListener("click", (e) => {
                  e.stopPropagation();
                  // Reset video to beginning and play
                  demoVideo.currentTime = 0;
                  togglePlayPause();
                });
              }

              // Add ended event to show a play button or visual indicator
              demoVideo.addEventListener("ended", () => {
                // Show the ended button
                endedButton.classList.remove("hidden");
                playButton.classList.add("hidden");
              });

              // Remove ended button when video starts playing again
              demoVideo.addEventListener("play", () => {
                endedButton.classList.add("hidden");
                playButton.classList.add("hidden");
              });

              // Show play button when video is paused
              demoVideo.addEventListener("pause", () => {
                // Don't show play button if video ended (we show the ended button instead)
                if (!demoVideo.ended) {
                  playButton.classList.remove("hidden");
                  endedButton.classList.add("hidden");
                }
              });

              // Add event listener to the submit button to hide the video when clicked
              const submitButton = document.getElementById('submitAnswer');
              if (submitButton) {
                submitButton.addEventListener('click', hideFirstTimeVideo);
              }
            }
          }
        }
      });
    </script>

    <!-- Footer -->
    <footer class="border-t border-gray-200 mt-8">
      <div
        class="max-w-5xl mx-auto flex justify-center space-x-6 px-4 py-6 text-center text-sm text-gray-600"
      >
        <a href="/privacy" class="text-gray-600 hover:text-gray-800">
          <span data-i18n="footer.privacyPolicy">Privacy Policy</span>
        </a>
        <a href="/terms" class="text-gray-600 hover:text-gray-800">
          <span data-i18n="footer.termsOfService">Terms of Service</span>
        </a>
        <a href="/contact">
          <span data-i18n="footer.contact">Contact</span>
        </a>
      </div>
    </footer>
    <script src="/static/js/achievementTooltips.js" defer></script>
  </body>
</html>
